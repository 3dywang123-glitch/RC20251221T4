# SoulSync AI 部署手册

本手册介绍如何部署 SoulSync AI 关系咨询应用的前端和后端服务。

## 项目概述

SoulSync AI 是一个基于 AI 的关系咨询应用，包含：
- **前端**：React + Vite + TypeScript 构建的用户界面
- **后端**：Express.js + PostgreSQL 的 API 服务
- **AI 集成**：支持 Gemini、Claude、GPT 等 AI 服务

## 前置要求

### 系统要求
- Node.js 18+
- PostgreSQL 15+
- Yarn 或 npm
- Git

### 环境准备
- Google AI Studio API 密钥（用于 Gemini）
- Zeabur 或其他云平台账户（推荐 Zeabur）

## 前端部署

### 1. 构建前端应用

```bash
# 安装依赖
npm install

# 构建生产版本
npm run build
```

构建完成后，会在 `dist/` 目录生成静态文件。

### 2. 部署到 Zeabur

1. 登录 [Zeabur Dashboard](https://dash.zeabur.com)
2. 点击 "New Project"
3. 选择 "Deploy from GitHub" 或 "Deploy from Git"
4. 连接您的仓库

### 3. 配置构建设置

**构建命令：**
- Build Command: `npm run build`
- Install Command: `npm install`
- Start Command: `npm run preview` 或使用静态文件服务

**环境变量：**
```env
NODE_ENV=production
```

### 4. 域名配置

更新后端的 `CORS_ORIGIN` 环境变量为前端域名。

## 后端部署

### 1. 安装依赖

```bash
cd server
npm install
```

### 2. 配置环境变量

复制 `.env.example` 到 `.env` 并配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```env
PORT=3001
DATABASE_URL=postgresql://user:password@localhost:5432/soulsync
JWT_SECRET=your-secret-key
GEMINI_API_KEY=your-api-key
AI_API_ENDPOINT=https://hnd1.aihub.zeabur.ai/
CORS_ORIGIN=https://your-frontend-domain.zeabur.app
```

### 3. 数据库设置

**创建 PostgreSQL 数据库：**
```bash
createdb soulsync
```

**运行迁移：**
```bash
npm run migrate
```

### 4. 部署到 Zeabur

#### 数据库设置
1. 在 Zeabur 中添加新服务
2. 选择 "PostgreSQL"
3. 配置数据库设置（推荐版本 15+）

#### 环境变量配置
在 Zeabur 服务设置中添加以下环境变量：

**必需变量：**
```env
DATABASE_URL=postgresql://username:password@host:5432/database
JWT_SECRET=your-super-secure-jwt-secret-key-change-this-in-production
GEMINI_API_KEY=your-gemini-api-key-from-google-ai-studio
AI_API_ENDPOINT=https://hnd1.aihub.zeabur.ai/
PORT=3000
NODE_ENV=production
CORS_ORIGIN=https://your-frontend-domain.zeabur.app
```

**可选变量：**
```env
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
MAX_FILE_SIZE=10485760
MAX_FILES_COUNT=10
```

#### 构建设置
- Build Command: `npm run build`
- Install Command: `npm install`
- Start Command: `npm start`

#### 健康检查
- 启用 "Health Check"
- Health Check Path: `/health`
- Health Check Method: `GET`

### 5. 数据库迁移

部署后运行迁移：
```bash
npm run migrate
```

## API 接口

### 认证接口
- `POST /api/auth/register` - 注册新用户
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/guest` - 创建访客会话

### 用户接口
- `GET /api/user/profile` - 获取用户资料
- `PUT /api/user/profile` - 更新用户资料
- `GET /api/user/payments` - 获取支付历史

### 目标接口
- `GET /api/targets` - 列出所有目标
- `GET /api/targets/:id` - 获取目标详情
- `POST /api/targets` - 创建新目标
- `PUT /api/targets/:id` - 更新目标
- `DELETE /api/targets/:id` - 删除目标
- `POST /api/targets/:id/personality` - 保存人格报告
- `POST /api/targets/:id/social-analysis` - 保存社交分析
- `POST /api/targets/:id/post-analysis` - 保存帖子分析
- `POST /api/targets/:id/relationship-report` - 保存关系报告

### 聊天接口
- `GET /api/chat/:targetId` - 获取聊天消息
- `POST /api/chat/:targetId` - 保存聊天消息
- `DELETE /api/chat/:targetId` - 清空聊天历史

### AI 接口
- `POST /api/ai/analyze-avatar` - 分析头像图片
- `POST /api/ai/analyze-personality` - 生成人格报告
- `POST /api/ai/analyze-social` - 分析社交媒体资料
- `POST /api/ai/persona-reply` - 生成人格回复
- `POST /api/ai/relationship-report` - 生成关系报告

## 数据库架构

### 数据表
- `users` - 用户账户
- `user_profiles` - 用户资料数据
- `target_profiles` - 目标人物资料
- `personality_reports` - 人格分析结果
- `social_analysis_results` - 社交媒体分析
- `social_post_analysis` - 单个帖子分析
- `relationship_reports` - 关系咨询报告
- `chat_messages` - 聊天对话历史
- `payment_transactions` - 支付记录

## 故障排除

### 常见问题

1. **构建失败：**
   - 检查所有依赖是否在 `package.json` 中
   - 确保 TypeScript 编译本地成功

2. **数据库连接：**
   - 验证 `DATABASE_URL` 格式
   - 检查数据库防火墙设置
   - 连接后运行迁移

3. **环境变量：**
   - 确保所有必需变量已设置
   - 检查变量名称是否完全匹配

4. **CORS 问题：**
   - 更新 `CORS_ORIGIN` 以匹配前端域名
   - 包含协议 (https://)

### 调试命令
```bash
# 检查数据库连接
npm run migrate

# 测试健康端点
curl https://your-service.zeabur.app/health

# 检查环境
echo $DATABASE_URL
echo $NODE_ENV
```

## 部署检查清单

- [ ] 项目克隆并安装依赖
- [ ] 数据库创建并获取连接字符串
- [ ] 环境变量配置
- [ ] 构建设置配置
- [ ] 数据库迁移运行
- [ ] 健康检查端点响应
- [ ] 前端 CORS 源配置
- [ ] 自定义域名配置（可选）
- [ ] 日志监控错误

## 成本估算

**免费层：**
- PostgreSQL: ~$0/月
- Node.js 服务: ~$0/月（有使用限制）

**生产环境（估算）：**
- PostgreSQL: $5-15/月
- Node.js 服务: $5-25/月
- 自定义域名: $3/月（可选）

## 替代部署平台

应用也可以部署到：
- **Railway**：与 Zeabur 类似，PostgreSQL 集成良好
- **Heroku**：传统 PaaS，易于扩展
- **DigitalOcean App Platform**：性价比高，性能良好
- **AWS**：更多控制，但复杂度更高
- **Vercel**：用于无服务器部署（需要代码修改）

确保：
1. 设置环境变量
2. 设置 PostgreSQL 数据库
3. 运行迁移
4. 为前端域名配置 CORS

## 安全说明

- 密码使用 bcrypt 哈希
- JWT 令牌用于认证
- Helmet.js 用于 HTTP 安全头
- CORS 配置为可信源
- API 端点速率限制
- 使用 express-validator 进行输入验证

---

**许可证**：私有项目 - 保留所有权利
